/**
 * Copyright since 2007 PrestaShop SA and Contributors
 * PrestaShop is an International Registered Trademark & Property of PrestaShop SA
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License version 3.0
 * that is bundled with this package in the file LICENSE.md.
 * It is also available through the world-wide-web at this URL:
 * https://opensource.org/licenses/AFL-3.0
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@prestashop.com so we can send you a copy immediately.
 *
 * @author    PrestaShop SA and Contributors <contact@prestashop.com>
 * @copyright Since 2007 PrestaShop SA and Contributors
 * @license   https://opensource.org/licenses/AFL-3.0 Academic Free License version 3.0
 */
(()=>{"use strict";var t={};t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}();const e=window.$;class s{constructor(t){this.id=t,this.$container=e("#"+this.id+"_grid")}getId(){return this.id}getContainer(){return this.$container}getHeaderContainer(){return this.$container.closest(".js-grid-panel").find(".js-grid-header")}addExtension(t){t.extend(this)}}const o=t.g.$,r=window.$;class i{extend(t){t.getContainer().on("click",".js-reset-search",(t=>{var e,s;e=r(t.currentTarget).data("url"),s=r(t.currentTarget).data("redirect"),o.post(e).then((()=>window.location.assign(s)))}))}}const a=t.g.$;class n{extend(t){const e=t.getContainer().find("table.table");new class{constructor(t){this.selector=".ps-sortable-column",this.columns=a(t).find(this.selector)}attach(){this.columns.on("click",(t=>{const e=a(t.delegateTarget);this._sortByColumn(e,this._getToggledSortDirection(e))}))}sortBy(t,e){const s=this.columns.is(`[data-sort-col-name="${t}"]`);if(!s)throw new Error(`Cannot sort by "${t}": invalid column`);this._sortByColumn(s,e)}_sortByColumn(t,e){window.location=this._getUrl(t.data("sortColName"),"desc"===e?"desc":"asc",t.data("sortPrefix"))}_getToggledSortDirection(t){return"asc"===t.data("sortDirection")?"desc":"asc"}_getUrl(t,e,s){const o=new URL(window.location.href),r=o.searchParams;return s?(r.set(s+"[orderBy]",t),r.set(s+"[sortOrder]",e)):(r.set("orderBy",t),r.set("sortOrder",e)),o.toString()}}(e).attach()}}class l{show(){this.progressModal.modal("show")}hide(){this.progressModal.modal("hide")}updateProgress(t,e){t=parseInt(t),e=parseInt(e);let s=this.progressBar,o=t/e*100;s.css("width",`${o}%`),s.find("> span").text(`${t}/${e}`)}updateProgressLabel(t){this.progressLabel.text(t)}setImportingProgressLabel(){this.updateProgressLabel(this.progressModal.find(".modal-body").data("importing-label"))}setImportedProgressLabel(){this.updateProgressLabel(this.progressModal.find(".modal-body").data("imported-label"))}showInfoMessages(t){this._showMessages(this.infoMessageBlock,t)}showWarningMessages(t){this._showMessages(this.warningMessageBlock,t)}showErrorMessages(t){this._showMessages(this.errorMessageBlock,t)}showSuccessMessage(){this.successMessageBlock.removeClass("d-none")}showPostLimitMessage(t){this.postLimitMessage.find("#post_limit_value").text(t),this.postLimitMessage.removeClass("d-none")}_showMessages(t,e){let s=!1;for(let o in e){s=!0;let r=$("<div>");r.text(e[o]),r.addClass("message"),t.append(r)}s&&t.removeClass("d-none")}showContinueImportButton(){this.continueImportButton.removeClass("d-none")}hideContinueImportButton(){this.continueImportButton.addClass("d-none")}showAbortImportButton(){this.abortImportButton.removeClass("d-none")}hideAbortImportButton(){this.abortImportButton.addClass("d-none")}showCloseModalButton(){this.closeModalButton.removeClass("d-none")}hideCloseModalButton(){this.closeModalButton.addClass("d-none")}clearWarningMessages(){this.warningMessageBlock.addClass("d-none").find(".message").remove()}reset(){this.updateProgress(0,0),this.updateProgressLabel(this.progressLabel.attr("default-value")),this.continueImportButton.addClass("d-none"),this.abortImportButton.addClass("d-none"),this.closeModalButton.addClass("d-none"),this.successMessageBlock.addClass("d-none"),this.infoMessageBlock.addClass("d-none").find(".message").remove(),this.errorMessageBlock.addClass("d-none").find(".message").remove(),this.postLimitMessage.addClass("d-none"),this.clearWarningMessages()}get progressModal(){return $("#import_progress_modal")}get progressBar(){return this.progressModal.find(".progress-bar")}get infoMessageBlock(){return $(".js-import-info")}get errorMessageBlock(){return $(".js-import-errors")}get warningMessageBlock(){return $(".js-import-warnings")}get successMessageBlock(){return $(".js-import-success")}get postLimitMessage(){return $(".js-post-limit-warning")}get continueImportButton(){return $(".js-continue-import")}get abortImportButton(){return $(".js-abort-import")}get closeModalButton(){return $(".js-close-modal")}get progressLabel(){return $("#import_progress_bar").find(".progress-details-text")}}class h{constructor(){this._targetExecutionTime=5e3,this._maxAcceleration=4,this._minBatchSize=5,this._maxBatchSize=100}markImportStart(){this._importStartTime=(new Date).getTime()}markImportEnd(){this._actualExecutionTime=(new Date).getTime()-this._importStartTime}_calculateAcceleration(){return Math.min(this._maxAcceleration,this._targetExecutionTime/this._actualExecutionTime)}calculateBatchSize(t,e=0){if(!this._importStartTime)throw"Import start is not marked.";if(!this._actualExecutionTime)throw"Import end is not marked.";let s=[this._maxBatchSize,Math.max(this._minBatchSize,Math.floor(t*this._calculateAcceleration()))];return e>0&&s.push(e),Math.min(...s)}}class d{constructor(){this.postSizeLimitThreshold=.9}isReachingPostSizeLimit(t,e){return e>=t*this.postSizeLimitThreshold}getRequiredPostSizeInMegabytes(t){return parseInt(t/1048576)}}class c{constructor(){this.configuration={},this.progressModal=new l,this.batchSizeCalculator=new h,this.postSizeChecker=new d,this.defaultBatchSize=5}import(t,e){this._mergeConfiguration(e),this.importUrl=t,this.totalRowsCount=0,this.hasWarnings=!1,this.hasErrors=!1,this.progressModal.reset(),this.progressModal.show(),this._ajaxImport(0,this.defaultBatchSize)}_ajaxImport(t,e,s=!0,o={}){this._mergeConfiguration({offset:t,limit:e,validateOnly:s?1:0,crossStepsVars:JSON.stringify(o)}),this._onImportStart(),$.post({url:this.importUrl,dataType:"json",data:this.configuration,success:o=>{if(this._importCancelRequested)return this._cancelImport(),!1;let r=o.errors&&o.errors.length,i=o.warnings&&o.warnings.length,a=o.notices&&o.notices.length;if(void 0!==o.totalCount&&o.totalCount&&(this.totalRowsCount=o.totalCount),this.progressModal.updateProgress(o.doneCount,this.totalRowsCount),s||this.progressModal.setImportingProgressLabel(),!s&&a&&this.progressModal.showInfoMessages(o.notices),r){if(this.hasErrors=!0,this.progressModal.showErrorMessages(o.errors),!s)return this._onImportStop(),!1}else i&&(this.hasWarnings=!0,this.progressModal.showWarningMessages(o.warnings));if(!o.isFinished){this.batchSizeCalculator.markImportEnd();let r=t+e,i=this.batchSizeCalculator.calculateBatchSize(e,this.totalRowsCount);return this.postSizeChecker.isReachingPostSizeLimit(o.postSizeLimit,o.nextPostSize)&&this.progressModal.showPostLimitMessage(this.postSizeChecker.getRequiredPostSizeInMegabytes(o.nextPostSize)),this._ajaxImport(r,i,s,o.crossStepsVariables)}if(s)return this.hasErrors?(this._onImportStop(),!1):this.hasWarnings?(this.progressModal.showContinueImportButton(),this._onImportStop(),!1):(this.progressModal.updateProgress(this.totalRowsCount,this.totalRowsCount),this._ajaxImport(0,this.defaultBatchSize,!1));this._onImportFinish()},error:(t,e,s)=>{"parsererror"===e&&(e="Technical error: Unexpected response returned by server. Import stopped."),this._onImportStop(),this.progressModal.showErrorMessages([e])}})}continueImport(){if(!this.configuration)throw"Missing import configuration. Make sure the import had started before continuing.";this.progressModal.hideContinueImportButton(),this.progressModal.hideCloseModalButton(),this.progressModal.clearWarningMessages(),this._ajaxImport(0,this.defaultBatchSize,!1)}set configuration(t){this._importConfiguration=t}get configuration(){return this._importConfiguration}set progressModal(t){this._modal=t}get progressModal(){return this._modal}requestCancelImport(){this._importCancelRequested=!0}_mergeConfiguration(t){for(let e in t)this._importConfiguration[e]=t[e]}_cancelImport(){this.progressModal.hide(),this._importCancelRequested=!1}_onImportStop(){this.progressModal.showCloseModalButton(),this.progressModal.hideAbortImportButton()}_onImportFinish(){this._onImportStop(),this.progressModal.showSuccessMessage(),this.progressModal.setImportedProgressLabel(),this.progressModal.updateProgress(this.totalRowsCount,this.totalRowsCount)}_onImportStart(){this.batchSizeCalculator.markImportStart(),this.progressModal.showAbortImportButton()}}const p=window.$;class m{extend(t){t.getContainer().on("click",".js-revert_import-row-action",(t=>{t.preventDefault();const e=p(t.currentTarget).data("confirm-message");if(e.length&&!confirm(e))return;let s=new c,o={};o.id=p(t.currentTarget).data("id"),s.import(p(t.currentTarget).data("url"),o)}))}}class g{constructor(){$(document).on("click",".js-change-import-file-btn",(()=>this.changeImportFileHandler())),this.toggleSelectedFile()}toggleSelectedFile(){let t=$("#csv").val();t.length>0&&(this.showImportFileAlert(t),this.hideFileUploadBlock())}uploadFile(){this.hideImportFileError(),this.disableProcessImportButton(),$.growl.notice({title:"Attendere..",message:"Caricamento file in corso.."});const t=$("#file"),e=t.prop("files")[0];if(t.data("max-file-upload-size")<e.size)return void this.showImportFileError(e.name,e.size,"File is too large");const s=new FormData;return s.append("file",e),$.ajax({type:"POST",url:$(".js-import-form").data("file-upload-url"),data:s,cache:!1,contentType:!1,processData:!1}).then((t=>{if(t.error)return void this.showImportFileError(e.name,e.size,t.error);let s=t.file.name;$(".js-import-file-input").val(s),this.showImportFileAlert(s),this.hideFileUploadBlock(),this.enableProcessImportButton()}))}hideImportFileError(){$(".js-import-file-error").addClass("d-none")}showImportFileError(t,e,s){const o=$(".js-import-file-error"),r=t+" ("+this.humanizeSize(e)+")";o.find(".js-file-data").text(r),o.find(".js-error-message").text(s),o.removeClass("d-none")}showImportFileAlert(t){$(".js-import-file-alert").removeClass("d-none"),$(".js-import-file").text(t)}hideFileUploadBlock(){$(".js-file-upload-input-wrapper").addClass("d-none")}changeImportFileHandler(){this.hideImportFileAlert(),this.showFileUploadBlock()}showFileUploadBlock(){$(".js-file-upload-input-wrapper").removeClass("d-none")}hideImportFileAlert(){$(".js-import-file-alert").addClass("d-none")}disableProcessImportButton(){$(".js-process-import").attr("disabled",!0)}enableProcessImportButton(){$(".js-process-import").removeAttr("disabled")}}const u=window.$;u((()=>{const t=new s("priceimportlog");t.addExtension(new i),t.addExtension(new n),t.addExtension(new m);var e=new c,o=new g;u(document).on("click",".js-process-import",(t=>function(t){t.preventDefault();let s={};u("#import-prices-form").find("input[name=skip]:checked, select[name^=type_value], #csv, #iso_lang, #entity,#truncate, #match_ref, #regenerate, #forceIDs, #sendemail,#separator, #multiple_value_separator, #price_tin").each(((t,e)=>{s[u(e).attr("name")]=u(e).val()})),e.import(u(t.currentTarget).data("import_url"),s)}(t))),u(document).on("click",".js-abort-import",(()=>e.requestCancelImport())),u(document).on("click",".js-close-modal",(()=>{e.progressModal.hide(),location.reload()})),u(document).on("click",".js-continue-import",(()=>e.continueImport())),u(document).on("change",".js-import-file",(()=>{o.uploadFile()}))}))})();